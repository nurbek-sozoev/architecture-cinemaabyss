# CinemaAbyss Proxy Service

Strangler Fig API Gateway –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã–π –Ω–∞ Node.js + TypeScript + Koa –¥–ª—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –æ—Ç –º–æ–Ω–æ–ª–∏—Ç–∞ –∫ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **Strangler Fig Pattern** - –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞
- **Feature Flags** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º –º–∏–≥—Ä–∞—Ü–∏–∏
- **Health Checks** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞
- **Request Routing** - –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
- **Error Handling** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ upstream —Å–µ—Ä–≤–∏—Å–æ–≤
- **Request/Response Logging** - –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **Graceful Shutdown** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Node.js 18+** - —Å—Ä–µ–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- **TypeScript** - —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è
- **Koa** - –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **Axios** - HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è
- **Docker** - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è

## üìù –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–°–µ—Ä–≤–∏—Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è                 | –û–ø–∏—Å–∞–Ω–∏–µ                              | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é            |
| -------------------------- | ------------------------------------- | ----------------------- |
| `PORT`                     | –ü–æ—Ä—Ç —Å–µ—Ä–≤–∏—Å–∞                          | `3200`                  |
| `MONOLITH_URL`             | URL –º–æ–Ω–æ–ª–∏—Ç–∞                          | `http://localhost:3280` |
| `MOVIES_SERVICE_URL`       | URL –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞ —Ñ–∏–ª—å–º–æ–≤              | `http://localhost:3281` |
| `EVENTS_SERVICE_URL`       | URL –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞ —Å–æ–±—ã—Ç–∏–π              | `http://localhost:3282` |
| `GRADUAL_MIGRATION`        | –í–∫–ª—é—á–∏—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é         | `true`                  |
| `MOVIES_MIGRATION_PERCENT` | –ü—Ä–æ—Ü–µ–Ω—Ç —Ç—Ä–∞—Ñ–∏–∫–∞ –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å (0-100) | `0`                     |
| `NODE_ENV`                 | –û–∫—Ä—É–∂–µ–Ω–∏–µ                             | `development`           |

## üéØ –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è

### Strangler Fig –¥–ª—è Movies API

```
/api/movies/* ‚Üí
‚îú‚îÄ‚îÄ [X% —Ç—Ä–∞—Ñ–∏–∫–∞] ‚Üí Movies Microservice
‚îî‚îÄ‚îÄ [100-X% —Ç—Ä–∞—Ñ–∏–∫–∞] ‚Üí Monolith
```

### –î—Ä—É–≥–∏–µ API

```
/api/events/* ‚Üí Events Service
/api/* ‚Üí Monolith (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
/health ‚Üí Health Check
```

## üö¶ –ó–∞–ø—É—Å–∫

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
npm install

# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å hot reload
npm run dev

# –°–±–æ—Ä–∫–∞
npm run build

# –ü—Ä–æ–¥–∞–∫—à–Ω –∑–∞–ø—É—Å–∫
npm start
```

### Docker

```bash
# –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
docker build -t cinemaabyss-proxy .

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker run -p 3200:3200 \
  -e MOVIES_MIGRATION_PERCENT=50 \
  cinemaabyss-proxy
```

### Docker Compose

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã
docker-compose up -d

# –¢–æ–ª—å–∫–æ –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–∏—Å
docker-compose up proxy-service
```

## üîç API Endpoints

### Health Check

```http
GET /health
```

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:

```json
{
  "status": "healthy",
  "service": "strangler-fig-proxy",
  "gradual_migration": true,
  "movies_migration_percent": 50,
  "timestamp": "2024-01-15T10:30:00.000Z",
  "uptime": 123456,
  "environment": "development",
  "upstream_services": {
    "monolith": "http://monolith:3280",
    "movies": "http://movies-service:3281",
    "events": "http://events-service:3282"
  }
}
```

### Proxied Requests

–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ–∫—Å–∏—Ä—É—é—Ç—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ upstream —Å–µ—Ä–≤–∏—Å—ã.

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏

–°–µ—Ä–≤–∏—Å –≤—ã–≤–æ–¥–∏—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏:

```
üîÄ Proxying GET /api/movies to http://movies-service:3281/api/movies
üìã Routing reason: Strangler Fig: 50% migration to microservice
‚úÖ Request completed in 45ms with status 200
```

### –ú–µ—Ç—Ä–∏–∫–∏

- Response time –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `X-Response-Time`
- Health check endpoint –¥–ª—è monitoring
- Docker health check –≤—Å—Ç—Ä–æ–µ–Ω

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

### 1. –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (0% –º–∏–≥—Ä–∞—Ü–∏–∏)

```bash
# –í–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ –≤ –º–æ–Ω–æ–ª–∏—Ç
docker-compose up -d
curl http://localhost:3200/api/movies
```

### 2. –ß–∞—Å—Ç–∏—á–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (50% –º–∏–≥—Ä–∞—Ü–∏–∏)

```bash
# –ò–∑–º–µ–Ω–∏—Ç—å MOVIES_MIGRATION_PERCENT –≤ docker-compose.yml
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
docker-compose restart proxy-service

# –ü–æ–ª–æ–≤–∏–Ω–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–π–¥–µ—Ç –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å
for i in {1..10}; do
  curl http://localhost:3200/api/movies
done
```

### 3. –ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (100% –º–∏–≥—Ä–∞—Ü–∏–∏)

```bash
# –í–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å
# MOVIES_MIGRATION_PERCENT=100
docker-compose restart proxy-service
curl http://localhost:3200/api/movies
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –ó–∞–ø—É—Å–∫ –æ—Ç –Ω–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
- –¢–∞–π–º–∞—É—Ç—ã –¥–ª—è upstream –∑–∞–ø—Ä–æ—Å–æ–≤
- Graceful error handling

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

```bash
# Health check
curl http://localhost:3200/health

# –õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker logs cinemaabyss-proxy-service

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
docker exec -it cinemaabyss-proxy-service sh
```

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **503 Service Unavailable** - upstream —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
2. **504 Gateway Timeout** - —Ç–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞
3. **502 Bad Gateway** - –æ—à–∏–±–∫–∞ –≤ upstream —Å–µ—Ä–≤–∏—Å–µ

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
- Connection pooling –¥–ª—è HTTP –∫–ª–∏–µ–Ω—Ç–∞
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

---

**–ì–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–∞–∫—à–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üöÄ
