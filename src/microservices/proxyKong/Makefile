# CinemaAbyss Kong Proxy Makefile

.PHONY: help start stop restart status logs clean config test health migration

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
KONG_ADMIN_URL = http://localhost:3201
KONG_PROXY_URL = http://localhost:3200

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN = \033[32m
YELLOW = \033[33m
BLUE = \033[34m
RED = \033[31m
NC = \033[0m # No Color

help: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
	@echo "$(BLUE)üîß CinemaAbyss Kong Proxy$(NC)"
	@echo ""
	@echo "$(GREEN)–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-15s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(GREEN)–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:$(NC)"
	@echo "  make start                    # –ó–∞–ø—É—Å—Ç–∏—Ç—å Kong"
	@echo "  make migration PERCENT=75     # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å 75% –º–∏–≥—Ä–∞—Ü–∏–∏"
	@echo "  make test COUNT=100           # –û—Ç–ø—Ä–∞–≤–∏—Ç—å 100 —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"

start: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å Kong Gateway
	@echo "$(GREEN)üöÄ –ó–∞–ø—É—Å–∫ Kong Gateway...$(NC)"
	@cd ../../../ && docker-compose --profile kong-proxy up -d

stop: ## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Kong Gateway
	@echo "$(YELLOW)üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Kong Gateway...$(NC)"
	@cd ../../../ && docker-compose --profile kong-proxy down

restart: stop start ## –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Kong Gateway

status: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å Kong
	@echo "$(BLUE)üìä –°—Ç–∞—Ç—É—Å Kong Gateway:$(NC)"
	@./scripts/kong-config.sh status

routes: ## –ü–æ–∫–∞–∑–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã
	@echo "$(BLUE)üó∫Ô∏è  –ú–∞—Ä—à—Ä—É—Ç—ã Kong:$(NC)"
	@./scripts/kong-config.sh routes

services: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã
	@echo "$(BLUE)üîß –°–µ—Ä–≤–∏—Å—ã Kong:$(NC)"
	@./scripts/kong-config.sh services

upstreams: ## –ü–æ–∫–∞–∑–∞—Ç—å upstreams
	@echo "$(BLUE)‚öñÔ∏è  Upstreams Kong:$(NC)"
	@./scripts/kong-config.sh upstreams

targets: ## –ü–æ–∫–∞–∑–∞—Ç—å targets
	@echo "$(BLUE)üéØ Targets Kong:$(NC)"
	@./scripts/kong-config.sh targets

logs: ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ Kong
	@echo "$(BLUE)üìã –õ–æ–≥–∏ Kong:$(NC)"
	@cd ../../../ && docker-compose logs -f kong-gateway

health: ## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–æ–≤
	@echo "$(BLUE)üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–æ–≤:$(NC)"
	@./scripts/kong-config.sh health

metrics: ## –ü–æ–∫–∞–∑–∞—Ç—å Prometheus –º–µ—Ç—Ä–∏–∫–∏
	@echo "$(BLUE)üìä Prometheus –º–µ—Ç—Ä–∏–∫–∏:$(NC)"
	@./scripts/kong-config.sh metrics

config: ## –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
	@echo "$(YELLOW)üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...$(NC)"
	@./scripts/kong-config.sh reload

test: ## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞—Ñ–∏–∫ (make test COUNT=100)
	@echo "$(BLUE)üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞...$(NC)"
	@./scripts/kong-config.sh test-traffic $(COUNT)

migration: ## –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (make migration PERCENT=75)
ifndef PERCENT
	@echo "$(RED)‚ùå –£–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç –º–∏–≥—Ä–∞—Ü–∏–∏: make migration PERCENT=75$(NC)"
	@exit 1
endif
	@echo "$(GREEN)üîÑ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: $(PERCENT)%$(NC)"
	@./scripts/kong-config.sh migration $(PERCENT)

# –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–∏
migration-0: ## 0% –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å (–≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ –≤ –º–æ–Ω–æ–ª–∏—Ç)
	@make migration PERCENT=0

migration-25: ## 25% –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å
	@make migration PERCENT=25

migration-50: ## 50% –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å
	@make migration PERCENT=50

migration-75: ## 75% –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å
	@make migration PERCENT=75

migration-100: ## 100% –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å (–≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å)
	@make migration PERCENT=100

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
test-movies: ## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API —Ñ–∏–ª—å–º–æ–≤
	@echo "$(BLUE)üé¨ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API —Ñ–∏–ª—å–º–æ–≤...$(NC)"
	@curl -i $(KONG_PROXY_URL)/api/movies

test-events: ## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API —Å–æ–±—ã—Ç–∏–π
	@echo "$(BLUE)üìÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API —Å–æ–±—ã—Ç–∏–π...$(NC)"
	@curl -i $(KONG_PROXY_URL)/api/events

test-health: ## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å health check
	@echo "$(BLUE)üè• –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ health check...$(NC)"
	@curl -i $(KONG_PROXY_URL)/health

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
monitor: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (tail –ª–æ–≥–æ–≤)
	@echo "$(BLUE)üëÄ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Kong (Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞)...$(NC)"
	@cd ../../../ && docker-compose logs -f kong-gateway

admin-ui: ## –û—Ç–∫—Ä—ã—Ç—å Admin UI –≤ –±—Ä–∞—É–∑–µ—Ä–µ
	@echo "$(GREEN)üñ•Ô∏è  –û—Ç–∫—Ä—ã—Ç–∏–µ Kong Admin UI...$(NC)"
	@open http://localhost:1337 || echo "–û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:1337 –≤ –±—Ä–∞—É–∑–µ—Ä–µ"

# –û—á–∏—Å—Ç–∫–∞
clean: ## –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ Kong
	@echo "$(RED)üßπ –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö Kong...$(NC)"
	@cd ../../../ && docker-compose --profile kong-proxy down -v
	@docker volume prune -f

clean-logs: ## –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
	@echo "$(YELLOW)üßπ –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤...$(NC)"
	@cd ../../../ && docker-compose logs --tail=0 kong-gateway

# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
dev: ## –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö)
	@echo "$(GREEN)üíª –†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏...$(NC)"
	@echo "–°–ª–µ–¥–∏—Ç–µ –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ kong.yml –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"
	@while true; do \
		inotifywait -e modify kong.yml 2>/dev/null && make config || sleep 1; \
	done

# –ë—ç–∫–∞–ø –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
backup: ## –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
	@echo "$(BLUE)üíæ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...$(NC)"
	@mkdir -p backups
	@curl -s $(KONG_ADMIN_URL)/config > backups/kong-config-$(shell date +%Y%m%d-%H%M%S).json
	@echo "–ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ø–∞–ø–∫–µ backups/"

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ
info: ## –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–µ–∫—Ç–µ
	@echo "$(BLUE)‚ÑπÔ∏è  –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ CinemaAbyss Kong Proxy:$(NC)"
	@echo ""
	@echo "üåê –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:"
	@echo "  Kong Proxy:     $(KONG_PROXY_URL)"
	@echo "  Kong Admin API: $(KONG_ADMIN_URL)"
	@echo "  Konga UI:       http://localhost:1337"
	@echo ""
	@echo "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞:"
	@tree -I 'node_modules|.git' . 2>/dev/null || ls -la
	@echo ""
	@echo "üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:"
	@echo "  –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: kong.yml"
	@echo "  Docker Compose:    docker-compose.yml"
	@echo "  –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:        .env (—Å–æ–∑–¥–∞–µ—Ç—Å—è –∏–∑ env.example)"

# –í–∞–ª–∏–¥–∞—Ü–∏—è
validate: ## –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Kong
	@echo "$(BLUE)‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Kong...$(NC)"
	@docker run --rm -v $(PWD)/kong.yml:/kong.yml kong:3.4-alpine kong config parse /kong.yml

# –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
quick-start: ## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (—É—Å—Ç–∞–Ω–æ–≤–∫–∞ + –∑–∞–ø—É—Å–∫ + —Ç–µ—Å—Ç—ã)
	@echo "$(GREEN)üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç CinemaAbyss Kong Proxy...$(NC)"
	@make start
	@sleep 10
	@make health
	@make test-movies
	@echo "$(GREEN)‚úÖ –ì–æ—Ç–æ–≤–æ! Kong Proxy –∑–∞–ø—É—â–µ–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω$(NC)"
